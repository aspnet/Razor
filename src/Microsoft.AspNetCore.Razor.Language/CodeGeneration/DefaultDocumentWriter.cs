// Copyright (c) .NET Foundation. All rights reserved.
// Licensed under the Apache License, Version 2.0. See License.txt in the project root for license information.

using System;
using System.Text;
using Microsoft.AspNetCore.Razor.Language.Intermediate;

namespace Microsoft.AspNetCore.Razor.Language.CodeGeneration
{
    internal class DefaultDocumentWriter : DocumentWriter
    {
        private readonly CodeRenderingContext _context;
        private readonly CodeTarget _target;

        public DefaultDocumentWriter(CodeTarget target, CodeRenderingContext context)
        {
            if (target == null)
            {
                throw new ArgumentNullException(nameof(target));
            }

            if (context == null)
            {
                throw new ArgumentNullException(nameof(context));
            }

            _target = target;
            _context = context;
        }

        public override void WriteDocument(DocumentIntermediateNode node)
        {
            if (node == null)
            {
                throw new ArgumentNullException(nameof(node));
            }

            var visitor = new Visitor(_target, _context);
            _context.SetRenderNode(visitor.Visit);
            _context.SetRenderChildren(visitor.RenderChildren);

            visitor.VisitDocument(node);

            _context.SetRenderChildren(null);
            _context.SetRenderNode(null);
        }

        private class Visitor : IntermediateNodeVisitor
        {
            private readonly CodeRenderingContext _context;
            private readonly CodeTarget _target;

            public Visitor(CodeTarget target, CodeRenderingContext context)
            {
                _target = target;
                _context = context;
            }

            private CodeRenderingContext Context => _context;

            public void RenderChildren(IntermediateNode node)
            {
                for (var i = 0; i < node.Children.Count; i++)
                {
                    var child = node.Children[i];
                    Visit(child);
                }
            }

            public override void VisitDocument(DocumentIntermediateNode node)
            {
                if (!Context.Options.SuppressChecksum)
                {
                    // See http://msdn.microsoft.com/en-us/library/system.codedom.codechecksumpragma.checksumalgorithmid.aspx
                    const string Sha1AlgorithmId = "{ff1816ec-aa5e-4d10-87f7-6f4963833460}";

                    var sourceDocument = Context.SourceDocument;

                    var checksum = sourceDocument.GetChecksum();
                    var fileHashBuilder = new StringBuilder(checksum.Length * 2);
                    foreach (var value in checksum)
                    {
                        fileHashBuilder.Append(value.ToString("x2"));
                    }

                    var bytes = fileHashBuilder.ToString();

                    if (!string.IsNullOrEmpty(bytes))
                    {
                        Context.CodeWriter
                            .Write("#pragma checksum \"")
                            .Write(sourceDocument.FilePath)
                            .Write("\" \"")
                            .Write(Sha1AlgorithmId)
                            .Write("\" \"")
                            .Write(bytes)
                            .WriteLine("\"");
                    }
                }

                Context.CodeWriter
                    .WriteLine("// <auto-generated/>")
                    .WriteLine("#pragma warning disable 1591");

                RenderChildren(node);

                Context.CodeWriter.WriteLine("#pragma warning restore 1591");
            }

            public override void VisitUsingDirective(UsingDirectiveIntermediateNode node)
            {
                Context.NodeWriter.WriteUsingDirective(Context, node);
            }

            public override void VisitNamespaceDeclaration(NamespaceDeclarationIntermediateNode node)
            {
                using (Context.CodeWriter.BuildNamespace(node.Content))
                {
                    Context.CodeWriter.WriteLine("#line hidden");
                    RenderChildren(node);
                }
            }

            public override void VisitClassDeclaration(ClassDeclarationIntermediateNode node)
            {
                using (Context.CodeWriter.BuildClassDeclaration(node.Modifiers, node.Name, node.BaseType, node.Interfaces))
                {
                    RenderChildren(node);
                }
            }

            public override void VisitMethodDeclaration(MethodDeclarationIntermediateNode node)
            {
                Context.CodeWriter.WriteLine("#pragma warning disable 1998");

                for (var i = 0; i < node.Modifiers.Count; i++)
                {
                    Context.CodeWriter.Write(node.Modifiers[i]);
                    Context.CodeWriter.Write(" ");
                }

                Context.CodeWriter
                    .Write(node.ReturnType)
                    .Write(" ")
                    .Write(node.Name)
                    .WriteLine("()");

                using (Context.CodeWriter.BuildScope())
                {
                    RenderChildren(node);
                }

                Context.CodeWriter.WriteLine("#pragma warning restore 1998");
            }

            public override void VisitFieldDeclaration(FieldDeclarationIntermediateNode node)
            {
                Context.CodeWriter.WriteField(node.Modifiers, node.Type, node.Name);
            }

            public override void VisitPropertyDeclaration(PropertyDeclarationIntermediateNode node)
            {
                Context.CodeWriter.WriteAutoPropertyDeclaration(node.Modifiers, node.Type, node.Name);
            }

            public override void VisitExtension(ExtensionIntermediateNode node)
            {
                node.WriteNode(_target, Context);
            }

            public override void VisitCSharpExpression(CSharpExpressionIntermediateNode node)
            {
                Context.NodeWriter.WriteCSharpExpression(Context, node);
            }

            public override void VisitCSharpCode(CSharpCodeIntermediateNode node)
            {
                Context.NodeWriter.WriteCSharpCode(Context, node);
            }

            public override void VisitHtmlAttribute(HtmlAttributeIntermediateNode node)
            {
                Context.NodeWriter.WriteHtmlAttribute(Context, node);
            }

            public override void VisitHtmlAttributeValue(HtmlAttributeValueIntermediateNode node)
            {
                Context.NodeWriter.WriteHtmlAttributeValue(Context, node);
            }

            public override void VisitCSharpExpressionAttributeValue(CSharpExpressionAttributeValueIntermediateNode node)
            {
                Context.NodeWriter.WriteCSharpExpressionAttributeValue(Context, node);
            }

            public override void VisitCSharpCodeAttributeValue(CSharpCodeAttributeValueIntermediateNode node)
            {
                Context.NodeWriter.WriteCSharpCodeAttributeValue(Context, node);
            }

            public override void VisitHtml(HtmlContentIntermediateNode node)
            {
                Context.NodeWriter.WriteHtmlContent(Context, node);
            }

            public override void VisitDeclareTagHelperFields(DeclareTagHelperFieldsIntermediateNode node)
            {
                Context.TagHelperWriter.WriteDeclareTagHelperFields(Context, node);
            }

            public override void VisitTagHelper(TagHelperIntermediateNode node)
            {
                var tagHelperRenderingContext = new TagHelperRenderingContext()
                {
                    TagName = node.TagName,
                    TagMode = node.TagMode
                };

                using (Context.Push(tagHelperRenderingContext))
                {
                    Context.TagHelperWriter.WriteTagHelper(Context, node);
                }
            }

            public override void VisitTagHelperBody(TagHelperBodyIntermediateNode node)
            {
                Context.TagHelperWriter.WriteTagHelperBody(Context, node);
            }

            public override void VisitCreateTagHelper(CreateTagHelperIntermediateNode node)
            {
                Context.TagHelperWriter.WriteCreateTagHelper(Context, node);
            }

            public override void VisitAddTagHelperHtmlAttribute(AddTagHelperHtmlAttributeIntermediateNode node)
            {
                Context.TagHelperWriter.WriteAddTagHelperHtmlAttribute(Context, node);
            }

            public override void VisitSetTagHelperProperty(SetTagHelperPropertyIntermediateNode node)
            {
                Context.TagHelperWriter.WriteSetTagHelperProperty(Context, node);
            }

            public override void VisitDefault(IntermediateNode node)
            {
                Context.RenderChildren(node);
            }
        }
    }
}
