<Project>
  <!-- 
    Targets supporting Razor MSBuild integration
  -->
  <Import Project="Microsoft.AspNetCore.Razor.Design.Compilation.targets" />

  <Target Name="RazorGenerate" DependsOnTargets="$(RazorGenerateDependsOn)">
  </Target>

  <Target Name="RazorCompile" DependsOnTargets="$(RazorCompileDependsOn)">
  </Target>

  <PropertyGroup Condition="'$(RazorCompileOnBuild)'=='true'">
    <PrepareForRunDependsOn>RazorCompile;$(PrepareForRunDependsOn)</PrepareForRunDependsOn>
  </PropertyGroup>

  <!-- 
    Default values for properties that affect Razor MSBuild behavior. 
  -->
  <PropertyGroup>
    <!-- Output directory used for generated files -->
    <RazorGenerateOutputPath Condition="'$(RazorGenerateOutputPath)'==''">$(IntermediateOutputPath)Razor\</RazorGenerateOutputPath>
    
    <!-- File name (without extension) of the assembly produced by Razor -->
    <RazorTargetName Condition="'$(RazorTargetName)'==''">$(TargetName).PrecompiledViews</RazorTargetName>
  </PropertyGroup>

  <!-- Implementation details here... -->
  <PropertyGroup>
    <!-- Used for tag helper discovery -->
    <_RazorTagHelperInputCache>$(IntermediateOutputPath)$(TargetName).TagHelpers.input.cache</_RazorTagHelperInputCache>
    <_RazorTagHelperOutputCache>$(IntermediateOutputPath)$(TargetName).TagHelpers.output.cache</_RazorTagHelperOutputCache>
    
    <!-- Used to locate our tools -->
    <_RazorGenerateToolAssembly>$(_RazorMSBuildRoot)tools\Microsoft.AspNetCore.Razor.GenerateTool.dll</_RazorGenerateToolAssembly>
    <_RazorTagHelperToolAssembly>$(_RazorMSBuildRoot)tools\Microsoft.AspNetCore.Razor.TagHelperTool.dll</_RazorTagHelperToolAssembly>
  </PropertyGroup>

  <!-- 
    Gathers input assemblies for Tag Helper discovery and compilation. Add items to @(ReferencePath)
  -->
  <Target
    Name="RazorResolveAssemblyReferences"
    DependsOnTargets="ResolveReferences">
    <ItemGroup>
      <RazorReferencePath Include="@(ReferencePath)"/>
      <RazorReferencePath Include="$([System.IO.Path]::GetFullPath('$(IntermediateOutputPath)$(TargetName)$(TargetExt)'))"/>
    </ItemGroup>
  </Target>

  <Target
    Name="_RazorResolveTagHelpers"
    DependsOnTargets="Compile;RazorResolveAssemblyReferences"
    Inputs="$(MSBuildAllProjects);@(RazorReferencePath)"
    Outputs="$(_RazorTagHelperInputCache)">

    <!-- 
      We're manipulating our output directly here because we want to separate the actual up-to-date check
      of RazorCoreGenerate from the output of this target. Many times the set of tag helpers doesn't change
      so we don't need to regenerate the code.
      -->
    <Touch
      Files="$(_RazorTagHelperInputCache)"
      AlwaysCreate="true">
      <Output
        TaskParameter="TouchedFiles"
        ItemName="FileWrites" />
    </Touch>

    <RazorTagHelper
      Debug="$(_RazorDebugTagHelperTask)"
      DebugTool="$(_RazorDebugTagHelperTool)"
      ToolAssembly="$(_RazorTagHelperToolAssembly)"
      Assemblies="@(RazorReferencePath)"
      TagHelperManifest="$(_RazorTagHelperOutputCache)">
      <Output
        TaskParameter="TagHelperManifest"
        ItemName="FileWrites"/>
    </RazorTagHelper>

  </Target>

  <Target Name="_ResolveRazorCoreGenerateInputs">

    <ItemGroup>
      <RazorGenerate Include="@(Content)" Condition="'%(Content.Extension)'=='.cshtml'" />
      <_RazorGenerateOutput Include="@(RazorGenerate->'$(RazorGenerateOutputPath)%(RelativeDir)%(Filename).cs')" />
    </ItemGroup>

    <PropertyGroup>
      <_RazorGenerateHashFile>$(IntermediateOutputPath)$(MSBuildProjectName).RazorCoreGenerate.cache</_RazorGenerateHashFile>
    </PropertyGroup>

    <Hash ItemsToHash="@(RazorGenerate)">
      <Output TaskParameter="HashResult" PropertyName="_RazorGenerateHash" />
    </Hash>

    <MakeDir
      Directories="$(IntermediateOutputPath)"
      Condition="!Exists('$(IntermediateOutputPath)')" />

    <WriteLinesToFile
      Lines="$(_RazorGenerateHash)"
      File="$(_RazorGenerateHashFile)"
      Overwrite="True"
      WriteOnlyWhenDifferent="True" />

    <ItemGroup>
      <FileWrites Include="$(_RazorGenerateHashFile)" />
    </ItemGroup>
  </Target>

  <Target
    Name="RazorCoreGenerate"
    DependsOnTargets="_ResolveRazorCoreGenerateInputs;_RazorResolveTagHelpers"
    Inputs="$(MSBuildAllProjects);$(_RazorGenerateHashFile);$(_RazorTagHelperOutputCache);@(RazorGenerate)"
    Outputs="@(_RazorGenerateOutput)">

    <RemoveDir
      Directories="$(RazorGenerateOutputPath)"
      Condition = "Exists('$(RazorGenerateOutputPath)')"/>

    <MakeDir
      Directories="%(_RazorGenerateOutput.RelativeDir)"
      Condition="!Exists('%(_RazorGenerateOutput.RelativeDir)')" />

    <RazorGenerate
      Debug="$(_RazorDebugGenerateCodeTask)"
      DebugTool="$(_RazorDebugGenerateCodeTool)"
      ToolAssembly="$(_RazorGenerateToolAssembly)"
      Sources="@(RazorGenerate)"
      ProjectRoot="$(MSBuildProjectDirectory)"
      TagHelperManifest="$(_RazorTagHelperOutputCache)"
      OutputPath="$(RazorGenerateOutputPath)" />

    <ItemGroup>
      <FileWrites Include="@(_RazorGenerateOutput)" />

      <!-- These items are used by RazorCoreCompile -->
      <RazorCompile Include="@(_RazorGenerateOutput)" />
    </ItemGroup>
  </Target>
</Project>
